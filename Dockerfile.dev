# ğŸ³ Dockerfile Simple pour le DÃ©veloppement
# Clean Architecture NestJS - Mode DEV optimisÃ©

FROM node:22.17-alpine

# ğŸ“ MÃ©tadonnÃ©es
LABEL maintainer="Clean Architecture Dev Team"
LABEL description="Clean Architecture NestJS - Development Environment"
LABEL environment="development"

# ğŸŒ Variables d'environnement de dÃ©veloppement
ENV NODE_ENV=development
ENV PORT=3000
ENV DEBUG=*

# ğŸ› ï¸ Installation des outils essentiels pour le dÃ©veloppement
RUN apk add --no-cache \
  dumb-init \
  curl \
  git \
  bash \
  vim \
  nano \
  tzdata

# ğŸ‘¤ CrÃ©ation d'un utilisateur non-root pour la sÃ©curitÃ©
RUN addgroup -g 1001 -S nodejs && \
  adduser -S nestjs -u 1001 -G nodejs

# ğŸ“ RÃ©pertoire de travail
WORKDIR /app

# ğŸ“¦ Copie et installation des dÃ©pendances
COPY package*.json ./

# ğŸš€ Installation de TOUTES les dÃ©pendances (dev + prod)
RUN npm ci && \
  npm cache clean --force

# ğŸ”§ Installation des outils de dÃ©veloppement globaux
RUN npm install -g \
  nodemon \
  @nestjs/cli \
  typescript

# ğŸ“‹ Copie du code source
COPY --chown=nestjs:nodejs . .

# ğŸ“‚ Ajustement des permissions
RUN chown -R nestjs:nodejs /app && \
  chmod -R 755 /app

# ğŸ‘¤ Changement vers l'utilisateur non-root
USER nestjs

# ğŸŒ Exposition des ports
EXPOSE 3000 9229

# â¤ï¸ Health check simple pour le dÃ©veloppement
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# ğŸš€ Point d'entrÃ©e et commande par dÃ©faut
ENTRYPOINT ["dumb-init", "--"]
CMD ["npm", "run", "start:dev"]
